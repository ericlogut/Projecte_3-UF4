<!DOCTYPE html>
<html>
  <head>
    <title>Juego de preguntas</title>
    <style>
      #pregunta,
      #respuestas
       {
        display: none;
      }
      #historialUsuarios {
        position: fixed;
        right: 0;
        top: 0;
        width: 200px;
        height: 100%;
        background-color: #eee;
        overflow-y: scroll;
      }
      #historialUsuarios ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #historialUsuarios li {
        margin: 5px;
        padding: 5px;
        background-color: #fff;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Juego de preguntas</h1>

    <div id="formularioRegistro">
      <label for="nombre">Ingrese su nombre:</label>
      <input type="text" id="nombre" />
      <button onclick="unirseAlJuego()">Unirse al juego</button>
    </div>

    <div id="pregunta"></div>
    <div id="respuestas"></div>
    <div id="puntuacion"></div>
    <div style="display: none;" id="cronometro">10</div>
    <div id="tiempo-restante"></div>

    <div style="display: none;" id="cuenta">60</div>
    <div id="cuenta-regresiva"></div>
    
    <div id="historialUsuarios">
      <h2>Historial de jugadores</h2>
      <ul></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const DURACION_TEMPORIZADOR = 10000; // Duración del temporizador en milisegundos
      let tiempoRestante = DURACION_TEMPORIZADOR / 1000; // Dividir por 1000 para convertir de milisegundos a segundos
      let tiempoRestanteCuentaRegresiva = DURACION_TEMPORIZADOR / 1000; // Dividir por 1000 para convertir de milisegundos a segundos
       let temporizador; // Variable para el temporizador
       let temporizadorCuentaRegresiva; // Variable para el temporizador
       let usuarioRegistrado = false; // Variable para verificar si el usuario se ha registrado

      function unirseAlJuego() {
        const nombre = document.getElementById("nombre").value;
        if (nombre) {
          document.getElementById("formularioRegistro").style.display = "none";
          document.getElementById("pregunta").style.display = "block";
          document.getElementById("respuestas").style.display = "block";
          socket.emit("nuevoJugador", nombre);
          usuarioRegistrado = true; // Establecer la variable en true cuando el usuario se registra

          // Eliminar el temporizador previo si existe
          clearInterval(temporizadorCuentaRegresiva);

        // Establecer el valor del temporizador
        tiempoRestanteCuentaRegresiva = DURACION_TEMPORIZADOR / 1000; // Utilizar la variable global tiempoRestante
        document.getElementById("cuenta").innerText = tiempoRestanteCuentaRegresiva;

        // Actualizar el valor del cronómetro y el tiempo restante cada segundo
        temporizadorCuentaRegresiva = setInterval(() => {
          tiempoRestanteCuentaRegresiva--;
          actualizarCuentaRegresiva();
        }, 1000);

          setTimeout(() => {
            detenerPartida();
          }, 60000); // 60000 milisegundos = 1 minuto
      }
  }

  function detenerPartida() {
  // Detener el temporizador actual
  clearInterval(temporizador);
  clearInterval(temporizadorCuentaRegresiva);
  socket.emit("detenerPartida");

  // Emitir evento para indicar que se debe detener la partida
}

// Función para actualizar el cronómetro
function actualizarCuentaRegresiva() {
  // Obtener los elementos del cronómetro y el tiempo restante
  const cuentaEl= document.getElementById("cuenta");
  const cuentaRegresivaEl = document.getElementById("cuenta-regresiva");

  // Si el usuario no se ha registrado, no iniciar el temporizador
  if (!usuarioRegistrado) {
    return;
  }

  // Obtener el valor actual del cronómetro
  let tiempoActual = parseInt(cuentaEl.innerText);

  // Si se agota el tiempo, detener el temporizador
  if (tiempoActual <= 0) {
    clearInterval(temporizadorCuentaRegresiva);
    tiempoActual = 0;
  } else {
    // Reducir el tiempo restante
    tiempoActual--;
  }

  // Actualizar el valor del cronómetro y el tiempo restante
  cuentaEl.innerText = tiempoActual;
  cuentaRegresivaEl.innerText = `Tiempo transcurrido: ${tiempoActual} segundos`;
}

      // Función para actualizar el cronómetro
      function actualizarCronometro() {
  // Obtener los elementos del cronómetro y el tiempo restante
  const cronometroEl = document.getElementById("cronometro");
  const tiempoRestanteEl = document.getElementById("tiempo-restante");

  // Si el usuario no se ha registrado, no iniciar el temporizador
  if (!usuarioRegistrado) {
    return;
  }

  // Obtener el valor actual del cronómetro
  let tiempoActual = parseInt(cronometroEl.innerText);

  // Si se agota el tiempo, detener el temporizador
  if (tiempoActual <= 0) {
    clearInterval(temporizador);
    tiempoActual = 0;
    socket.emit("enviarRespuesta", "");
    socket.emit("siguientePregunta");
  } else {
    // Reducir el tiempo restante
    tiempoActual--;
  }

  // Actualizar el valor del cronómetro y el tiempo restante
  cronometroEl.innerText = tiempoActual;
  tiempoRestanteEl.innerText = `Tiempo restante: ${tiempoActual} segundos`;
}

      // Manejador de eventos para cuando se recibe una nueva pregunta
      socket.on("nuevaPregunta", (pregunta) => {
  const preguntaEl = document.getElementById("pregunta");
  const respuestasEl = document.getElementById("respuestas");

  // Eliminar el temporizador previo si existe
  clearInterval(temporizador);

  // Establecer el valor del temporizador
  tiempoRestante = DURACION_TEMPORIZADOR / 1000; // Utilizar la variable global tiempoRestante
  document.getElementById("cronometro").innerText = tiempoRestante;

  // Actualizar el valor del cronómetro y el tiempo restante cada segundo
  temporizador = setInterval(() => {
    tiempoRestante--;
    actualizarCronometro();
  }, 1000);

  // Mostrar la pregunta
  preguntaEl.innerText = pregunta.pregunta;

  // Mostrar las opciones de respuesta
  respuestasEl.innerHTML = "";
  pregunta.respuestas.forEach((respuesta) => {
    const opcionEl = document.createElement("button");
    opcionEl.innerText = respuesta;
    opcionEl.addEventListener("click", () => {
      socket.emit("enviarRespuesta", respuesta);

      // Detener el temporizador
      clearInterval(temporizador);

      // Restablecer el valor del cronómetro y del tiempo restante
      document.getElementById("cronometro").innerText = DURACION_TEMPORIZADOR / 1000;
      document.getElementById("tiempo-restante").innerText = "";
    });
    respuestasEl.appendChild(opcionEl);
  });
});




      // Manejador de eventos para actualizar la puntuación
      socket.on("actualizarPuntuacion", (jugadores) => {
        const puntuacionEl = document.getElementById("puntuacion");
        puntuacionEl.innerHTML = "";
        Object.keys(jugadores).forEach((jugadorId) => {
          const jugador = jugadores[jugadorId];
          const jugadorEl = document.createElement("div");
          jugadorEl.innerText = `${jugador.nombre}: ${jugador.puntos} puntos`;
          puntuacionEl.appendChild(jugadorEl);
        });
      });

      // Manejador de eventos para actualizar el historial de usuarios
      socket.on("actualizarHistorialUsuarios", (historialUsuarios) => {
        const historialUsuariosEl = document.getElementById("historialUsuarios");
        historialUsuariosEl.innerHTML = "";

        historialUsuarios.forEach((usuario) => {
          const usuarioEl = document.createElement("div");
          usuarioEl.innerText = usuario + " se ha añadido a la partida";
          historialUsuariosEl.appendChild(usuarioEl);
        });
      });

    </script>
  </body>
</html>
